<div class="w-full text-white min-h-screen">
  <div *ngIf="loading && !issue" class="text-center py-12 backdrop-blur-md bg-white/10 rounded-2xl border border-white/20 shadow-lg">
    <p-progressSpinner [style]="{ width: '50px', height: '50px', margin: 'auto' }"></p-progressSpinner>
    <p class="text-gray-300 mt-4">Loading issue...</p>
  </div>

  <div *ngIf="notFound && !loading" class="text-center py-12 backdrop-blur-md bg-white/10 rounded-2xl border border-white/20 shadow-lg">
    <i class="pi pi-exclamation-circle text-5xl text-yellow-400 mb-4 block"></i>
    <h2 class="text-2xl font-semibold text-white mb-2">Issue Not Found</h2>
    <p class="text-gray-300 mb-8">The issue you're looking for doesn't exist or has been deleted.</p>
    <button class="bg-gradient-to-r from-pink-600 via-purple-700 to-blue-800 text-white px-6 py-2 rounded-xl shadow-lg hover:opacity-90 transition" (click)="goToDashboard()">Back to Dashboard</button>
  </div>

  <div *ngIf="permissionDenied && !loading && !isEditMode" class="text-center py-12 backdrop-blur-md bg-white/10 rounded-2xl border border-white/20 shadow-lg">
    <i class="pi pi-lock text-4xl text-red-500 mb-3"></i>
    <h2 class="text-xl font-semibold text-white mb-2">Permission Denied</h2>
    <p class="text-gray-300 mb-6">Only admins or the issue creator can edit this issue.</p>
    <button class="bg-gradient-to-r from-pink-600 via-purple-700 to-blue-800 text-white px-5 py-2 rounded-xl shadow-lg hover:opacity-90 transition" (click)="goToDashboard()">Back to Dashboard</button>
  </div>

  <div *ngIf="issue && !notFound && !loading" class="space-y-6">
    <div class="backdrop-blur-lg bg-white/10 border border-white/20 rounded-xl shadow-2xl overflow-hidden">
      <div class="p-6 border-b border-white/10">
        <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-4">
          <div class="flex-1">
            <p class="text-gray-400 text-xs uppercase tracking-wide mb-2 font-semibold flex items-center gap-2">
              <i class="pi pi-tag"></i>
              {{ issue.id }}
            </p>
            <h1 class="text-3xl font-bold text-white mb-3">{{ issue.title }}</h1>
            <div class="flex items-center gap-2 text-sm text-gray-300">
              <i class="pi pi-user text-gray-400"></i>
              <span>Created by <span class="font-semibold">{{ getUserName(issue.createdBy) }}</span></span>
              <span class="text-gray-500">â€¢</span>
              <span>{{ issue.createdAt | date:'medium' }}</span>
            </div>
          </div>
          <div class="flex gap-3 flex-wrap">
            <span [ngClass]="'px-4 py-2 rounded-lg border flex items-center gap-2 font-semibold ' + getStateClass(issue.state)">
              <i [ngClass]="'pi ' + getStateIcon(issue.state)"></i>
              {{ issue.state | titlecase }}
            </span>
            <span *ngIf="isOverdue()" class="px-4 py-2 rounded-lg bg-red-400/20 text-red-300 border border-red-400/30 font-semibold flex items-center gap-2">
              <i class="pi pi-exclamation-triangle"></i> Overdue
            </span>
          </div>
        </div>
      </div>

      <div class="border-b border-white/10">
        <div class="flex px-6">
          <button 
            [class.border-b-2]="!isEditMode" 
            [class.border-blue-400]="!isEditMode"
            [class.text-white]="!isEditMode"
            [class.text-gray-400]="isEditMode"
            class="px-4 py-3 font-semibold transition hover:text-white"
            (click)="exitEditMode()">
            <i class="pi pi-eye mr-2"></i>Details
          </button>
          <button 
            *ngIf="canEditIssue()"
            [class.border-b-2]="isEditMode" 
            [class.border-blue-400]="isEditMode"
            [class.text-white]="isEditMode"
            [class.text-gray-400]="!isEditMode"
            class="px-4 py-3 font-semibold transition hover:text-white"
            (click)="enterEditMode()">
            <i class="pi pi-pencil mr-2"></i>Edit
          </button>
        </div>
      </div>

      <div class="p-6">
        <div class="two-col grid grid-cols-1 lg:grid-cols-[2fr_1fr] gap-6 items-stretch">
          <div class="left-col h-full space-y-6">
            <div *ngIf="!isEditMode" class="space-y-6">
              <div class="mb-6 pb-6 border-b border-white/10">
                <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wide mb-3">Description</h3>
                <p class="text-gray-200 leading-relaxed whitespace-pre-wrap">{{ issue.description }}</p>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 pb-6 border-b border-white/10">
                <div class="bg-white/5 rounded-lg p-4 border border-white/10">
                  <p class="text-gray-400 text-xs uppercase tracking-wide mb-2 font-semibold flex items-center gap-2">
                    <i class="pi pi-user"></i>Assigned To
                  </p>
                  <p class="text-white font-medium text-lg">{{ getUserName(issue.assignedTo) }}</p>
                </div>
                <div class="bg-white/5 rounded-lg p-4 border border-white/10">
                  <p class="text-gray-400 text-xs uppercase tracking-wide mb-2 font-semibold flex items-center gap-2">
                    <i class="pi pi-clock"></i>Last Updated
                  </p>
                  <p class="text-white font-medium text-lg">{{ issue.updatedAt | date:'medium' }}</p>
                </div>
              </div>

              <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white/5 rounded-lg p-4 border border-white/10">
                  <p class="text-gray-400 text-xs uppercase tracking-wide mb-2 font-semibold">Estimated Time</p>
                  <p class="text-2xl font-bold text-blue-300">{{ issue.estimatedTime }}h</p>
                </div>
                <div class="bg-white/5 rounded-lg p-4 border border-white/10">
                  <p class="text-gray-400 text-xs uppercase tracking-wide mb-2 font-semibold">Completed Time</p>
                  <p class="text-2xl font-bold text-green-300">{{ issue.completedTime }}h</p>
                </div>
                <div class="bg-white/5 rounded-lg p-4 border border-white/10">
                  <p class="text-gray-400 text-xs uppercase tracking-wide mb-2 font-semibold">Delay/Effort</p>
                  <p [ngClass]="calculateDelay() > 0 ? 'text-red-300' : 'text-green-300'" class="text-2xl font-bold">
                    {{ calculateDelay() > 0 ? '+' : '' }}{{ calculateDelay() }}h
                  </p>
                </div>
                <div class="bg-white/5 rounded-lg p-4 border border-white/10" [ngClass]="isOverdue() ? 'border-red-400/50' : ''">
                  <p class="text-gray-400 text-xs uppercase tracking-wide mb-2 font-semibold">Due Date</p>
                  <p [ngClass]="isOverdue() ? 'text-red-300' : 'text-white'" class="text-lg font-bold">
                    {{ issue.dueDate | date:'mediumDate' }}
                  </p>
                </div>
              </div>

              <div class="flex flex-wrap gap-3 pt-4 border-t border-white/10">
                <button 
                  *ngIf="canDeleteIssue()"
                  class="px-6 py-2 bg-red-500/20 hover:bg-red-500/30 border border-red-400/30 rounded-lg font-semibold transition flex items-center gap-2 text-red-200"
                  (click)="deleteIssue()">
                  <i class="pi pi-trash"></i> Delete Issue
                </button>
                <button 
                  class="px-6 py-2 bg-white/10 hover:bg-white/20 border border-white/20 rounded-lg font-semibold transition flex items-center gap-2 ml-auto text-neutral-200"
                  (click)="goBack()">
                  <i class="pi pi-arrow-left"></i> Back
                </button>
              </div>
            </div>

            <div *ngIf="isEditMode" class="form-wrap h-full">
              <p-message *ngIf="success" severity="success" text="Issue updated successfully!" styleClass="mb-6 w-full"></p-message>
              <p-message *ngIf="error" severity="error" [text]="error" styleClass="mb-6 w-full"></p-message>

              <div *ngIf="hasChanges" class="bg-yellow-400/10 border border-yellow-500/30 rounded-lg p-4 mb-6 flex gap-3">
                <i class="pi pi-exclamation-triangle text-yellow-400 text-xl"></i>
                <div>
                  <p class="font-semibold text-yellow-300">Unsaved Changes</p>
                  <p class="text-gray-200 text-sm">Click "Update Issue" to save them.</p>
                </div>
              </div>

              <form (ngSubmit)="onSubmit($event)" class="space-y-6 text-white h-full" novalidate>
                <div>
                  <label class="block text-sm font-semibold mb-2">Title</label>
                  <input
                    pInputText
                    [(ngModel)]="title"
                    (input)="onInputChange()"
                    name="title"
                    placeholder="Enter issue title"
                    class="w-full bg-white/10 border border-white/20 rounded-lg px-3 py-2 focus:ring-2 focus:ring-purple-500 placeholder-gray-400"
                    required />
                </div>

                <div>
                  <label class="block text-sm font-semibold mb-2">Description</label>
                  <textarea
                    pInputTextarea
                    [(ngModel)]="description"
                    (input)="onInputChange()"
                    name="description"
                    rows="5"
                    placeholder="Issue description"
                    class="w-full bg-white/10 border border-white/20 rounded-lg px-3 py-2 focus:ring-2 focus:ring-purple-500 placeholder-gray-400"
                    required>
                  </textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label class="block text-sm font-semibold mb-2">State</label>
                    <p-dropdown
                      [(ngModel)]="state"
                      (onChange)="onInputChange()"
                      name="state"
                      [options]="stateOptions"
                      optionLabel="label"
                      optionValue="value"
                      styleClass="w-full glass-dropdown"
                      [disabled]="loading">
                    </p-dropdown>
                  </div>

                  <div>
                    <label class="block text-sm font-semibold mb-2">Assigned To</label>
                    <p-dropdown
                      [(ngModel)]="assignedTo"
                      (onChange)="onInputChange()"
                      name="assignedTo"
                      [options]="userOptions"
                      optionLabel="label"
                      optionValue="value"
                      styleClass="w-full glass-dropdown"
                      [disabled]="loading">
                    </p-dropdown>
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label class="block text-sm font-semibold mb-2">Estimated Time (hrs)</label>
                    <p-inputNumber
                      [(ngModel)]="estimatedTime"
                      (onInput)="onInputChange()"
                      name="estimatedTime"
                      [min]="1"
                      [max]="1000"
                      styleClass="w-full glass-input"
                      [disabled]="loading">
                    </p-inputNumber>
                  </div>

                  <div>
                    <label class="block text-sm font-semibold mb-2">Completed Time (hrs)</label>
                    <p-inputNumber
                      [(ngModel)]="completedTime"
                      (onInput)="onInputChange()"
                      name="completedTime"
                      [min]="0"
                      [max]="1000"
                      styleClass="w-full glass-input"
                      [disabled]="loading">
                    </p-inputNumber>
                  </div>
                </div>

                <div>
                  <label class="block text-sm font-semibold mb-2">Due Date</label>
                  <p-calendar
                    [(ngModel)]="dueDate"
                    name="dueDate"
                    (onSelect)="onInputChange()"
                    [showIcon]="true"
                    styleClass="w-full glass-input"
                    [disabled]="loading">
                  </p-calendar>
                </div>

                <div class="bg-blue-500/10 border border-blue-400/20 rounded-lg p-4 text-sm">
                  <i class="pi pi-info-circle text-blue-400 mr-2"></i>
                  All updates will be logged with timestamps for tracking.
                </div>

                <div class="flex flex-wrap gap-4 pt-6 border-t border-white/10">
                  <button 
                    type="submit" 
                    class="bg-gradient-to-r from-pink-600 via-purple-700 to-blue-800 text-white shadow-lg hover:opacity-90 transition px-6 py-2 rounded-xl font-semibold" 
                    [disabled]="loading || !hasChanges">
                    <i class="pi pi-check mr-2"></i>Update Issue
                  </button>
                  <button 
                    type="button" 
                    class="px-6 py-2 rounded-xl bg-yellow-500/20 hover:bg-yellow-500/30 border border-yellow-400/30 transition font-semibold" 
                    (click)="resetForm()">
                    <i class="pi pi-refresh mr-2"></i>Reset
                  </button>
                  <button 
                    type="button" 
                    class="px-6 py-2 rounded-xl bg-green-500/20 hover:bg-green-500/30 border border-green-400/30 transition font-semibold" 
                    (click)="markAsCompleted()">
                    <i class="pi pi-check-circle mr-2"></i>Mark Completed
                  </button>
                  <button 
                    type="button" 
                    class="px-6 py-2 rounded-xl bg-white/10 hover:bg-white/20 border border-white/20 transition ms-auto font-semibold" 
                    (click)="exitEditMode()">
                    <i class="pi pi-times mr-2"></i>Cancel
                  </button>
                </div>
              </form>
            </div>
          </div>

        
          <aside class="right-col lg:sticky lg:top-4 h-full space-y-4">
            <div class="backdrop-blur-lg bg-white/10 border border-white/20 rounded-xl shadow-2xl overflow-hidden h-fit">
              <div class="px-4 py-3 border-b border-white/10">
                <h4 class="text-sm font-semibold text-white">Details</h4>
              </div>
              <div class="p-4 space-y-3 text-sm">
                <div class="flex items-center justify-between">
                  <span class="text-gray-400">Remaining Work</span>
                  <span class="font-semibold text-white">
                    {{ (issue.estimatedTime || 0) - (issue.completedTime || 0) | number:'1.0-1' }}h
                  </span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-gray-400">Activity</span>
                  <span class="font-semibold text-white">{{ issue.state | titlecase }}</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-gray-400">Completed Hours</span>
                  <span class="font-semibold text-white">{{ issue.completedTime }}h</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-gray-400">Estimated Hours</span>
                  <span class="font-semibold text-white">{{ issue.estimatedTime }}h</span>
                </div>
              </div>
            </div>

       
            <div class="backdrop-blur-lg bg-white/10 border border-white/20 rounded-xl shadow-2xl overflow-hidden activity-panel flex flex-col">
              <div class="px-4 py-3 border-b border-white/10">
                <h4 class="text-sm font-semibold text-white flex items-center gap-2">
                  <i class="pi pi-clock text-blue-400"></i> Activity Log
                </h4>
              </div>

              <div class="p-4 grow overflow-auto">
                <div *ngIf="activityLogs && activityLogs.length > 0; else noActivity" class="space-y-4">
                  <div *ngFor="let log of activityLogs" class="bg-white/5 border border-white/10 rounded-lg p-4 flex gap-4 hover:bg-white/10 transition">
                    <div class="flex-shrink-0">
                      <span class="flex items-center justify-center w-10 h-10 rounded-full bg-white/10 border border-white/20">
                        <i [ngClass]="'pi ' + getActivityIcon(log.action) + ' text-blue-400'"></i>
                      </span>
                    </div>
                    <div class="flex-1">
                      <div class="flex items-center justify-between flex-wrap gap-2">
                        <p class="font-semibold text-white">{{ getActivityActionText(log.action) }}</p>
                        <p class="text-xs text-gray-400">{{ log.timestamp | date:'medium' }}</p>
                      </div>
                      <p class="text-sm text-gray-300 mt-1">by <span class="font-medium">{{ log.userName }}</span></p>

                      <div *ngIf="log.changes && log.changes.length > 0" class="mt-3 space-y-1">
                        <p *ngFor="let change of log.changes" class="text-sm text-gray-300 flex items-start gap-2">
                          <i class="pi pi-arrow-right text-blue-400 text-xs mt-1"></i>
                          <span class="flex-1">
                            <span class="font-medium text-white">{{ change.field | titlecase }}:</span>
                            <span class="text-red-300 line-through mx-2">
                              {{ change.field === 'dueDate' ? (change.oldValue | date:'MMM d, y, h:mm a') : change.oldValue }}
                            </span>
                            <i class="pi pi-arrow-right text-gray-500 mx-1"></i>
                            <span class="text-green-300 font-medium">
                              {{ change.field === 'dueDate' ? (change.newValue | date:'MMM d, y, h:mm a') : change.newValue }}
                            </span>
                          </span>
                        </p>
                      </div>
                    </div>
                  </div>
                </div>

                <ng-template #noActivity>
                  <div class="text-center py-8">
                    <i class="pi pi-inbox text-3xl text-gray-500 mb-2 block"></i>
                    <p class="text-gray-400">No activity yet</p>
                    <p class="text-gray-500 text-xs mt-1">Activity will appear here as changes are made</p>
                  </div>
                </ng-template>
              </div>
            </div>
          </aside>
        </div>
      </div>
    </div>
  </div>
</div>
